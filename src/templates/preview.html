
<!doctype html>
<html>
<head>
    <title>文件预览 - {{ filename }}</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;">
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(120deg, #eff6ff, #f8fafc);
            color: #0f172a;
        }
        a { text-decoration: none; }
        .page-wrapper {
            max-width: 1080px;
            margin: 48px auto;
            padding: 0 24px 48px;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }
        .card {
            background: #ffffff;
            border-radius: 18px;
            padding: 28px;
            box-shadow: 0 24px 48px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(148, 163, 184, 0.16);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
        }
        .header h1 {
            margin: 0;
            font-size: 30px;
            font-weight: 700;
            color: #0f172a;
        }
        .header .subtitle { margin-top: 6px; font-size: 15px; color: #475569; }
        .nav-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 18px;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
        }
        .btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35); }
        .btn-primary {
            background: linear-gradient(90deg, #2563eb, #1d4ed8);
            color: #ffffff;
            box-shadow: 0 12px 24px rgba(29, 78, 216, 0.28);
        }
        .btn-primary:hover { background: linear-gradient(90deg, #1d4ed8, #1e40af); transform: translateY(-1px); }
        .btn-secondary {
            background: rgba(15, 23, 42, 0.08);
            color: #1f2937;
        }
        .btn-secondary:hover { background: rgba(15, 23, 42, 0.12); transform: translateY(-1px); }
        .btn-outline {
            background: transparent;
            border: 1px solid rgba(15, 23, 42, 0.12);
            color: #1f2937;
        }
        .btn-outline:hover { background: rgba(15, 23, 42, 0.05); transform: translateY(-1px); }
        .meta-card {
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: linear-gradient(135deg, #eef2ff, #ffffff);
        }
        .meta-grid { display: flex; flex-wrap: wrap; gap: 20px; }
        .meta-item { flex: 1 1 220px; display: flex; flex-direction: column; gap: 6px; }
        .meta-label { font-size: 12px; letter-spacing: 0.08em; text-transform: uppercase; color: #64748b; }
        .meta-value { font-size: 16px; font-weight: 600; color: #0f172a; word-break: break-all; }
        .preview-card { display: flex; flex-direction: column; gap: 20px; }
        .helper-text { font-size: 13px; color: #64748b; }
        .alert { padding: 16px 20px; border-radius: 14px; font-size: 14px; font-weight: 500; }
        .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .preview-content {
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: rgba(255, 255, 255, 0.95);
            max-height: 70vh;
            overflow: auto;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            padding: 18px 20px;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 14px;
            color: #0f172a;
            background: transparent;
        }
        code { font-family: 'JetBrains Mono', 'Courier New', monospace; }
        pre code.hljs {
            padding: 0 !important;
            background: transparent !important;
            display: block;
            overflow-x: auto;
        }
        img { max-width: 100%; height: auto; display: block; border-radius: 14px; }
        .pdf-container { width: 100%; height: 70vh; border: none; border-radius: 12px; }
        .no-preview {
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            color: #475569;
            background: rgba(59, 130, 246, 0.08);
        }
        .no-preview p { margin: 12px 0; }
        .preview-error { border-radius: 14px; padding: 18px 20px; background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; }
        .toggle-buttons { display: flex; gap: 12px; flex-wrap: wrap; }
        .toggle-btn {
            background: rgba(15, 23, 42, 0.08);
            color: #1f2937;
            border-radius: 999px;
            padding: 8px 18px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
        }
        .toggle-btn:hover { background: rgba(37, 99, 235, 0.2); color: #1d4ed8; transform: translateY(-1px); }
        .toggle-btn.active { background: linear-gradient(90deg, #2563eb, #1d4ed8); color: #ffffff; box-shadow: 0 10px 20px rgba(29, 78, 216, 0.28); }
        .markdown-content { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.65; padding: 20px; }
        .markdown-content h1 { color: #0f172a; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
        .markdown-content h2 { color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 6px; }
        .markdown-content h3 { color: #334155; }
        .markdown-content code { background-color: rgba(15, 23, 42, 0.08); padding: 2px 6px; border-radius: 6px; }
        .markdown-content pre { background-color: rgba(15, 23, 42, 0.08); padding: 16px; border-radius: 12px; overflow: auto; }
        .markdown-content blockquote { border-left: 4px solid #93c5fd; padding: 0 18px; color: #475569; }
        .markdown-content ul, .markdown-content ol { padding-left: 26px; }
        .markdown-content a { color: #1d4ed8; }
        .markdown-content table { border-collapse: collapse; width: 100%; margin: 16px 0; }
        .markdown-content th, .markdown-content td { border: 1px solid #e2e8f0; padding: 8px 12px; }
        .markdown-content th { background-color: rgba(59, 130, 246, 0.1); }
        .highlight .hll { background-color: #ffffcc }
        .highlight  { background: #f8f8f8; }
        .highlight .c { color: #408080; font-style: italic }
        .highlight .err { border: 1px solid #FF0000 }
        .highlight .k { color: #008000; font-weight: bold }
        .highlight .o { color: #666666 }
        .highlight .cm { color: #408080; font-style: italic }
        .highlight .cp { color: #BC7A00 }
        .highlight .c1 { color: #408080; font-style: italic }
        .highlight .cs { color: #408080; font-style: italic }
        .highlight .gd { color: #A00000 }
        .highlight .ge { font-style: italic }
        .highlight .gr { color: #FF0000 }
        .highlight .gh { color: #000080; font-weight: bold }
        .highlight .gi { color: #00A000 }
        .highlight .go { color: #888888 }
        .highlight .gp { color: #000080; font-weight: bold }
        .highlight .gs { font-weight: bold }
        .highlight .gu { color: #800080; font-weight: bold }
        .highlight .gt { color: #0044DD }
        .highlight .kc { color: #008000; font-weight: bold }
        .highlight .kd { color: #008000; font-weight: bold }
        .highlight .kn { color: #008000; font-weight: bold }
        .highlight .kp { color: #008000 }
        .highlight .kr { color: #008000; font-weight: bold }
        .highlight .kt { color: #B00040 }
        .highlight .m { color: #666666 }
        .highlight .s { color: #BA2121 }
        .highlight .na { color: #7D9029 }
        .highlight .nb { color: #008000 }
        .highlight .nc { color: #0000FF; font-weight: bold }
        .highlight .no { color: #880000 }
        .highlight .nd { color: #AA22FF }
        .highlight .ni { color: #999999; font-weight: bold }
        .highlight .ne { color: #D2413A; font-weight: bold }
        .highlight .nf { color: #0000FF }
        .highlight .nl { color: #A0A000 }
        .highlight .nn { color: #0000FF; font-weight: bold }
        .highlight .nt { color: #008000; font-weight: bold }
        .highlight .nv { color: #19177C }
        .highlight .ow { color: #AA22FF; font-weight: bold }
        .highlight .w { color: #bbbbbb }
        .highlight .mf { color: #666666 }
        .highlight .mh { color: #666666 }
        .highlight .mi { color: #666666 }
        .highlight .mo { color: #666666 }
        .highlight .sb { color: #BA2121 }
        .highlight .sc { color: #BA2121 }
        .highlight .sd { color: #BA2121; font-style: italic }
        .highlight .s2 { color: #BA2121 }
        .highlight .se { color: #BB6622; font-weight: bold }
        .highlight .sh { color: #BA2121 }
        .highlight .si { color: #BB6688; font-weight: bold }
        .highlight .sx { color: #008000 }
        .highlight .sr { color: #BB6688 }
        .highlight .s1 { color: #BA2121 }
        .highlight .ss { color: #19177C }
        .highlight .bp { color: #008000 }
        .highlight .vc { color: #19177C }
        .highlight .vg { color: #19177C }
        .highlight .vi { color: #19177C }
        .highlight .il { color: #666666 }
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; }
            .nav-actions { width: 100%; }
            .meta-grid { flex-direction: column; }
            .preview-content { max-height: none; }
            .pdf-container { height: 60vh; }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header class="header card">
            <div>
                <h1>文件预览</h1>
                <p class="subtitle">支持常见文本、图片与 PDF 的快速查看。</p>
            </div>
            <div class="nav-actions">
                <a href="/" class="btn btn-secondary">返回文件管理</a>
                <a href="/download/{{ filename }}" class="btn btn-primary">下载文件</a>
            </div>
        </header>

        <section class="card meta-card">
            <div class="meta-grid">
                <div class="meta-item">
                    <span class="meta-label">文件名</span>
                    <span class="meta-value">{{ filename }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">文件大小</span>
                    <span class="meta-value">{{ file_size }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">修改时间</span>
                    <span class="meta-value">{{ modified_time }}</span>
                </div>
            </div>
        </section>

        <section class="card preview-card">
            {% if error %}
            <div class="preview-error"><strong>预览错误:</strong> {{ error }}</div>
            {% elif preview_type == 'text' %}
            <div class="toggle-buttons">
                <button id="rawBtn" class="toggle-btn active" onclick="toggleView('raw')">纯文本</button>
                <button id="renderedBtn" class="toggle-btn" onclick="toggleView('rendered')">渲染显示</button>
            </div>
            <div class="preview-content">
                <pre id="rawContent" style="display: block;">{{ content }}</pre>
                <div id="renderedContent" style="display: none; padding: 20px;"></div>
            </div>
            {% elif preview_type == 'image' %}
            <div class="preview-content" style="padding: 20px;">
                <img src="/download/{{ filename }}" alt="{{ filename }}">
            </div>
            {% elif preview_type == 'pdf' %}
            <div class="preview-content" style="padding: 20px;">
                <embed src="/download/{{ filename }}" type="application/pdf" class="pdf-container">
                <p class="helper-text" style="margin-top:16px; color:#475569;">如果未能显示，请直接<a href="/download/{{ filename }}" style="color:#1d4ed8;">下载文件</a>。</p>
            </div>
            {% elif preview_type == 'archive' %}
            <div class="no-preview">
                <p>这是一个压缩包文件（{{ filename.split('.')[-1].lower()|upper }} 格式）。</p>
                <p><a href="/download/{{ filename }}" class="btn btn-primary">下载后解压查看内容</a></p>
            </div>
            {% else %}
            <div class="no-preview">
                <p>该文件类型暂不支持在线预览。</p>
                <p><a href="/download/{{ filename }}" class="btn btn-primary">点击下载到本地查看</a></p>
            </div>
        {% endif %}
        </section>
    </div>

    <script type="application/json" id="previewContentData">{{ (content|default('', true))|tojson }}</script>
    <script>
        // 获取文件扩展名
        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }
        
        // 切换视图
        function toggleView(view) {
            const rawBtn = document.getElementById('rawBtn');
            const renderedBtn = document.getElementById('renderedBtn');
            const rawContent = document.getElementById('rawContent');
            const renderedContent = document.getElementById('renderedContent');
            
            if (view === 'raw') {
                rawBtn.classList.add('active');
                renderedBtn.classList.remove('active');
                rawContent.style.display = 'block';
                renderedContent.style.display = 'none';
            } else {
                rawBtn.classList.remove('active');
                renderedBtn.classList.add('active');
                rawContent.style.display = 'none';
                renderedContent.style.display = 'block';
                
                // 渲染内容
                renderContent();
            }
        }
        
        // 渲染内容
        function renderContent() {
            const filename = "{{ filename }}";
            const extension = getFileExtension(filename);
            const contentDataEl = document.getElementById('previewContentData');
            let contentData = '';
            if (contentDataEl) {
                try {
                    contentData = JSON.parse(contentDataEl.textContent || '""');
                } catch (err) {
                    console.warn('Failed to parse preview content JSON', err);
                    contentData = '';
                }
            }
            const renderedContent = document.getElementById('renderedContent');
            
            if (!contentData) {
                renderedContent.innerHTML = '<p>该文件类型不支持渲染显示。</p>';
                return;
            }
            
            if (extension === 'md') {
                const md = markdownit();
                renderedContent.innerHTML = '<div class=\"markdown-content\">' + md.render(contentData) + '</div>';
            } else if (['py', 'js', 'java', 'c', 'cpp', 'html', 'css', 'php', 'sql', 'xml', 'json', 'yaml', 'yml', 'ini', 'cfg', 'conf', 'sh', 'pl', 'rb', 'go'].includes(extension)) {
                const escapedContent = contentData
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
                renderedContent.innerHTML = '<pre><code class=\"language-' + extension + '\">' + escapedContent + '</code></pre>';
                if (typeof hljs !== 'undefined' && typeof hljs.highlightAll === 'function') {
                    hljs.highlightAll();
                }
            } else {
                const escapedContent = contentData
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
                renderedContent.innerHTML = '<pre>' + escapedContent + '</pre>';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const rawBtn = document.getElementById('rawBtn');
            if (rawBtn) {
                rawBtn.classList.add('active');
            }
        });
    </script>
</body>
</html>
