# CLAUDE.md

此文件为 Claude Code (claude.ai/code) 在此代码仓库中工作时提供指导。

## 项目概述

这是一个基于 Flask 的文件上传和下载服务，具有用户认证功能。该应用程序允许用户：
- 认证后通过 Web 界面上传文件
- 通过 URL 直接下载文件（无需认证）
- 查看所有已上传文件的列表及其元数据（大小、修改时间）
- 通过 Web 界面删除单个文件（需要认证）
- 批量选择并删除多个文件（需要认证）

## 常用命令

### 开发

1. **启动服务**：
   ```bash
   docker-compose up -d
   ```

2. **停止服务**：
   ```bash
   docker-compose down
   ```

3. **查看日志**：
   ```bash
   docker-compose logs
   ```

4. **重新构建 Docker 镜像**：
   ```bash
   docker-compose build --no-cache
   ```

5. **重启服务**（快速重启，不重新构建）：
   ```bash
   ./quick_restart.sh
   ```
   
6. **开发说明**：
   - 代码已挂载到容器中，修改代码后只需重启服务即可生效，无需重新构建镜像
   - 使用 `.dockerignore` 文件排除不必要的文件，减小镜像大小
   - Dockerfile 优化了构建缓存，依赖安装步骤会被缓存

### 测试

1. **运行认证测试**：
   ```bash
   ./test_auth_upload_download.sh
   ```

2. **运行功能测试**：
   ```bash
   ./test_new_features.sh
   ```

3. **测试自定义凭据**：
   ```bash
   ./test_custom_credentials.sh
   ```

4. **安全校验测试**：
   ```bash
   ./test_security_validation.sh
   ```

5. **路径遍历防护测试**：
   ```bash
   ./test_path_traversal.sh
   ```

6. **错误消息显示测试**：
   ```bash
   ./test_error_display.sh
   ```

7. **前端错误处理测试**：
   ```bash
   ./test_frontend_error.sh
   ```

## 代码架构

### 主要组件

1. **app.py** - 核心 Flask 应用程序，包含：
   - 使用基于会话的登录的用户认证
   - 文件上传、下载和删除端点
   - 带有元数据的文件列表
   - 用于 UI 渲染的 HTML 模板
   - 批量文件操作功能（新增）

2. **Dockerfile** - 定义容器镜像，包含：
   - Python 3.9 slim 基础镜像
   - Flask 依赖项
   - 用于配置的环境变量

3. **docker-compose.yml** - 编排文件，用于：
   - 构建和运行应用程序容器
   - 挂载本地 `uploads` 目录以实现持久化存储
   - 从 `.env` 文件加载配置

4. **.env** - 环境配置文件，包含：
   - ADMIN_USERNAME - 登录的管理员用户名
   - ADMIN_PASSWORD - 登录的管理员密码
   - FLASK_DEBUG - 调试模式设置

### 关键特性

1. **用户认证**：
   - 通过环境变量配置凭据
   - 使用 Werkzeug 的安全函数对密码进行哈希处理
   - 为已登录用户进行会话管理

2. **文件操作**：
   - 上传：认证用户可通过 Web 表单上传文件
   - 下载：通过直接 URL 公开访问
   - 删除：认证用户可删除文件
   - 列表：认证用户可查看所有文件及其元数据

3. **安全性**：
   - 默认在生产环境中禁用调试模式
   - 上传/删除操作需要基于会话的认证
   - 无需认证即可直接下载文件
   - 文件类型白名单校验，防止上传恶意文件
   - 文件名校验，防止路径遍历攻击
   - 文件名字符和长度限制，防止非法文件名
   - 明确的错误提示，帮助用户理解上传限制
   - 使用python-dotenv正确加载环境变量，确保会话安全

### 新增功能

1. **取消上传**：
   - 用户可以在文件上传过程中取消上传
   - 提供"取消上传"按钮，点击后终止上传进程

2. **存储限制检查**：
   - 前端检查文件大小是否超出存储限制
   - 在上传前提示用户存储空间不足

3. **Docker优化**：
   - 使用.dockerignore排除不必要的文件
   - 代码挂载到容器中，修改后快速重启即可生效
   - 提供快速重启脚本`./quick_restart.sh`

4. **改进的错误处理**：
   - 明确的错误消息显示，帮助用户理解上传限制
   - 针对不同类型的错误提供具体的解决方案建议
   - AJAX请求返回JSON格式错误信息，避免页面刷新
   - 前端JavaScript正确处理各种错误响应
   - 会话安全增强，确保用户认证状态正确维护
   - 前端JavaScript设置X-Requested-With头部以获取JSON格式响应

5. **批量文件操作**：
   - 支持选择多个文件并批量删除
   - 提供全选/取消全选功能
   - 确认对话框防止误操作

6. **安全增强**：
   - 修复了在日志中记录明文密码的安全问题
   - 现在只在日志中记录用户名，不记录密码

7. **项目结构优化**：
   - 将 requirements.txt 移动到项目根目录，符合标准实践
   - 改进了 Dockerfile 以适应新的文件结构

### 测试脚本

1. **安全校验测试**：
   ```bash
   ./test_security_validation.sh
   ```

2. **路径遍历防护测试**：
   ```bash
   ./test_path_traversal.sh
   ```

3. **错误消息显示测试**：
   ```bash
   ./test_error_display.sh
   ```

4. **前端错误处理测试**：
   ```bash
   ./test_frontend_error.sh
   ```

5. **批量操作测试**：
   - 手动测试批量删除功能
   - 验证全选/取消全选功能
   - 测试确认对话框防止误操作

### 数据流

1. 用户访问 `/` → 如果未认证则重定向到登录页面
2. 用户使用凭据登录 → 如果有效则创建会话
3. 已认证用户可以：
   - 通过 POST 到 `/upload` 上传文件
   - 在 `/` 或 `/upload` (GET) 查看文件列表
   - 通过 GET 请求到 `/delete/<filename>` 删除单个文件
   - 通过 POST 请求到 `/delete_selected` 批量删除多个文件
4. 任何人都可以通过 GET 请求到 `/download/<filename>` 下载文件

### 配置

应用程序通过环境变量进行配置：
- `ADMIN_USERNAME` 和 `ADMIN_PASSWORD` 用于登录凭据
- `FLASK_DEBUG` 控制调试模式
- 这些可以在 `.env` 文件中为本地开发进行设置
- git 提交信息使用中文